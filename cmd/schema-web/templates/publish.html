{{define "publish.html"}}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì‹œì§€ ê²Œì‹œ - Schema Registry</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --bg: #0f172a; --bg-card: #1e293b; --bg-hover: #334155;
            --text: #f1f5f9; --text-muted: #94a3b8; --border: #334155;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); padding: 20px; position: fixed; height: 100vh; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .logo-sub { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 30px; }
        .nav-section { margin-bottom: 24px; }
        .nav-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text); text-decoration: none; border-radius: 8px; margin-bottom: 4px; transition: all 0.2s; }
        .nav-link:hover, .nav-link.active { background: var(--primary); }
        .nav-icon { width: 20px; text-align: center; }
        .main { flex: 1; margin-left: 260px; padding: 30px 40px; }
        .page-header { margin-bottom: 30px; }
        .page-title { font-size: 1.75rem; font-weight: 600; margin-bottom: 8px; }
        .page-subtitle { color: var(--text-muted); }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 1.1rem; font-weight: 600; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .table { width: 100%; border-collapse: collapse; }
        .table th { text-align: left; padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 500; font-size: 0.85rem; }
        .table td { padding: 16px; border-bottom: 1px solid var(--border); }
        .table tr:hover { background: var(--bg-hover); }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-decoration: none; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { background: #475569; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover { background: var(--bg-hover); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
        .form-textarea { min-height: 200px; font-family: 'Consolas', monospace; resize: vertical; }
        .code-block { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px; font-family: 'Consolas', monospace; font-size: 0.9rem; }
        .alert { padding: 16px 20px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); color: var(--success); }
        .alert-danger { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .text-muted { color: var(--text-muted); }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        a { color: var(--primary); text-decoration: none; }
        code { background: var(--bg); padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="logo">Schema Registry</div>
            <div class="logo-sub">RabbitMQ Message Schemas</div>
            <nav class="nav-section">
                <div class="nav-title">ë©”ë‰´</div>
                <a href="/" class="nav-link"><span class="nav-icon">ğŸ“Š</span>ëŒ€ì‹œë³´ë“œ</a>
                <a href="/schemas" class="nav-link"><span class="nav-icon">ğŸ“‹</span>ìŠ¤í‚¤ë§ˆ ëª©ë¡</a>
                <a href="/validate" class="nav-link"><span class="nav-icon">âœ…</span>ê²€ì¦ ë„êµ¬</a>
                <a href="/publish" class="nav-link active"><span class="nav-icon">ğŸš€</span>ë©”ì‹œì§€ ê²Œì‹œ</a>
            </nav>
            <nav class="nav-section">
                <div class="nav-title">ì™¸ë¶€ ë§í¬</div>
                <a href="http://localhost:15672" target="_blank" class="nav-link"><span class="nav-icon">ğŸ°</span>RabbitMQ UI</a>
            </nav>
        </aside>
        <main class="main">
<div class="page-header">
    <h1 class="page-title">ë©”ì‹œì§€ ê²Œì‹œ</h1>
    <p class="page-subtitle">ìŠ¤í‚¤ë§ˆ ê¸°ë°˜ìœ¼ë¡œ RabbitMQì— ë©”ì‹œì§€ë¥¼ ê²Œì‹œí•©ë‹ˆë‹¤</p>
</div>

<!-- ì—°ê²° ìƒíƒœ -->
<div class="card" style="margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 12px;">
        {{if .Connected}}
        <span style="width: 12px; height: 12px; background: var(--success); border-radius: 50%;"></span>
        <span class="text-success">RabbitMQ ì—°ê²°ë¨</span>
        {{else}}
        <span style="width: 12px; height: 12px; background: var(--danger); border-radius: 50%;"></span>
        <span class="text-danger">RabbitMQ ì—°ê²° ì•ˆë¨</span>
        <span class="text-muted" style="margin-left: 8px;">docker-compose up -d ë¡œ RabbitMQë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”</span>
        {{end}}
    </div>
</div>

<div class="grid-2">
    <div class="card">
        <h3 class="card-title mb-4">ğŸ“¤ ë©”ì‹œì§€ ë°œí–‰</h3>

        <div class="form-group">
            <label class="form-label">ìŠ¤í‚¤ë§ˆ ì„ íƒ</label>
            <select id="schemaSelect" class="form-select" onchange="loadSampleData()">
                <option value="">-- ìŠ¤í‚¤ë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                {{range .Schemas}}
                <option value="{{.Name}}">{{.Name}} (v{{.Version}})</option>
                {{end}}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Exchange</label>
            <input type="text" id="exchange" class="form-input" value="schema.events" placeholder="schema.events">
        </div>

        <div class="form-group">
            <label class="form-label">Routing Key</label>
            <input type="text" id="routingKey" class="form-input" placeholder="ìë™ ì„¤ì • (ìŠ¤í‚¤ë§ˆ ì´ë¦„ ê¸°ë°˜)">
        </div>

        <div class="form-group">
            <label class="form-label">ë©”ì‹œì§€ ë°ì´í„° (JSON)</label>
            <textarea id="messageData" class="form-textarea" placeholder='{"key": "value"}'></textarea>
        </div>

        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="validateBeforePublish" checked>
                <span>ë°œí–‰ ì „ ìŠ¤í‚¤ë§ˆ ê²€ì¦</span>
            </label>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="publishMessage()" class="btn btn-primary" {{if not .Connected}}disabled{{end}}>
                ğŸš€ ë©”ì‹œì§€ ë°œí–‰
            </button>
            <button onclick="loadSampleData()" class="btn btn-outline">ğŸ“ ìƒ˜í”Œ ë°ì´í„°</button>
        </div>

        <div id="publishResult" class="mt-4" style="display: none;"></div>
    </div>

    <div class="card">
        <h3 class="card-title mb-4">ğŸ“‹ ë°œí–‰ ì˜µì…˜ ê°€ì´ë“œ</h3>

        <div class="mb-4">
            <h4 style="font-size: 0.9rem; margin-bottom: 8px;">Exchange íƒ€ì…</h4>
            <ul class="text-muted" style="padding-left: 20px; font-size: 0.85rem;">
                <li><strong>topic</strong>: íŒ¨í„´ ê¸°ë°˜ ë¼ìš°íŒ… (ê¸°ë³¸ê°’)</li>
                <li><strong>direct</strong>: ì •í™•í•œ routing key ë§¤ì¹­</li>
                <li><strong>fanout</strong>: ëª¨ë“  ë°”ì¸ë”©ëœ íì— ì „ë‹¬</li>
            </ul>
        </div>

        <div class="mb-4">
            <h4 style="font-size: 0.9rem; margin-bottom: 8px;">Routing Key íŒ¨í„´</h4>
            <ul class="text-muted" style="padding-left: 20px; font-size: 0.85rem;">
                <li><code>order.created</code> - ì£¼ë¬¸ ìƒì„±</li>
                <li><code>payment.completed</code> - ê²°ì œ ì™„ë£Œ</li>
                <li><code>user.login</code> - ì‚¬ìš©ì ë¡œê·¸ì¸</li>
            </ul>
        </div>

        <div>
            <h4 style="font-size: 0.9rem; margin-bottom: 8px;">ë©”ì‹œì§€ í—¤ë” (ìë™ ì¶”ê°€)</h4>
            <div class="code-block" style="font-size: 0.8rem;">
<pre>{
  "schema_name": "OrderEvent",
  "schema_version": 1,
  "published_at": "2024-01-15T..."
}</pre>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">ğŸ“Š ë°œí–‰ íˆìŠ¤í† ë¦¬</h3>
        <button onclick="refreshHistory()" class="btn btn-outline btn-sm">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>ì‹œê°„</th>
                <th>ìŠ¤í‚¤ë§ˆ</th>
                <th>Exchange</th>
                <th>Routing Key</th>
                <th>ê²°ê³¼</th>
            </tr>
        </thead>
        <tbody id="historyTable">
            {{range .History}}
            <tr>
                <td class="text-muted">#{{.ID}}</td>
                <td class="text-muted">{{.Timestamp.Format "15:04:05"}}</td>
                <td><strong>{{.SchemaName}}</strong></td>
                <td>{{.Exchange}}</td>
                <td><code>{{.RoutingKey}}</code></td>
                <td>
                    {{if .Success}}
                    <span class="text-success">âœ… ì„±ê³µ</span>
                    {{else}}
                    <span class="text-danger" title="{{.Error}}">âŒ ì‹¤íŒ¨</span>
                    {{end}}
                </td>
            </tr>
            {{else}}
            <tr>
                <td colspan="6" class="text-muted" style="text-align: center; padding: 30px;">
                    ë°œí–‰ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
</div>

<script>
const sampleData = {
    'OrderEvent': {
        "order_id": "ORD-" + Date.now(),
        "customer_id": "CUST-100",
        "amount": 150000,
        "status": "created",
        "created_at": new Date().toISOString()
    },
    'PaymentEvent': {
        "payment_id": "PAY-" + Date.now(),
        "order_id": "ORD-001",
        "amount": 50000,
        "currency": "KRW",
        "status": "completed"
    },
    'UserEvent': {
        "user_id": "USR-" + Date.now(),
        "action": "login",
        "timestamp": new Date().toISOString()
    },
    'NotificationEvent': {
        "type": "email",
        "recipient": "user@example.com",
        "subject": "ì£¼ë¬¸ í™•ì¸",
        "body": "ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤."
    }
};

function loadSampleData() {
    const schemaName = document.getElementById('schemaSelect').value;
    if (schemaName && sampleData[schemaName]) {
        document.getElementById('messageData').value = JSON.stringify(sampleData[schemaName], null, 2);
        document.getElementById('routingKey').value = schemaName.toLowerCase().replace('event', '');
    }
}

async function publishMessage() {
    const schemaName = document.getElementById('schemaSelect').value;
    const exchange = document.getElementById('exchange').value || 'schema.events';
    const routingKey = document.getElementById('routingKey').value || schemaName.toLowerCase();
    const dataStr = document.getElementById('messageData').value;
    const validate = document.getElementById('validateBeforePublish').checked;
    const resultDiv = document.getElementById('publishResult');

    if (!schemaName) {
        alert('ìŠ¤í‚¤ë§ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (!dataStr.trim()) {
        alert('ë©”ì‹œì§€ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    let data;
    try {
        data = JSON.parse(dataStr);
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">âŒ ì˜ëª»ëœ JSON í˜•ì‹: ' + err.message + '</div>';
        resultDiv.style.display = 'block';
        return;
    }

    try {
        const response = await fetch('/api/publish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                schema_name: schemaName,
                exchange: exchange,
                routing_key: routingKey,
                data: data,
                validate: validate
            })
        });

        const result = await response.json();

        if (result.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>âœ… ë©”ì‹œì§€ ë°œí–‰ ì„±ê³µ!</strong><br>
                    <small>Exchange: ${exchange}, Routing Key: ${routingKey}</small>
                </div>`;
            refreshHistory();
        } else {
            let errorHtml = `<div class="alert alert-danger"><strong>âŒ ë°œí–‰ ì‹¤íŒ¨</strong><br>${result.error}`;
            if (result.data && result.data.validation) {
                errorHtml += '<ul style="margin-top: 8px;">';
                result.data.validation.errors.forEach(e => {
                    errorHtml += `<li>${e}</li>`;
                });
                errorHtml += '</ul>';
            }
            errorHtml += '</div>';
            resultDiv.innerHTML = errorHtml;
            refreshHistory();
        }
        resultDiv.style.display = 'block';
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">âŒ ìš”ì²­ ì‹¤íŒ¨: ' + err.message + '</div>';
        resultDiv.style.display = 'block';
    }
}

async function refreshHistory() {
    try {
        const response = await fetch('/api/publish/history');
        const result = await response.json();

        if (result.success) {
            updateHistoryTable(result.data);
        }
    } catch (err) {
        console.error('íˆìŠ¤í† ë¦¬ ì¡°íšŒ ì‹¤íŒ¨:', err);
    }
}

function updateHistoryTable(history) {
    const tbody = document.getElementById('historyTable');

    if (!history || history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-muted" style="text-align: center; padding: 30px;">ë°œí–‰ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
    }

    let html = '';
    history.slice(0, 20).forEach(item => {
        const time = new Date(item.timestamp).toLocaleTimeString('ko-KR');
        html += `<tr>
            <td class="text-muted">#${item.id}</td>
            <td class="text-muted">${time}</td>
            <td><strong>${item.schema_name}</strong></td>
            <td>${item.exchange}</td>
            <td><code>${item.routing_key}</code></td>
            <td>${item.success
                ? '<span class="text-success">âœ… ì„±ê³µ</span>'
                : `<span class="text-danger" title="${item.error}">âŒ ì‹¤íŒ¨</span>`
            }</td>
        </tr>`;
    });

    tbody.innerHTML = html;
}
</script>
        </main>
    </div>
</body>
</html>
{{end}}
