{{template "base" .}}

{{define "content"}}
<div class="page-header">
    <h1 class="page-title">ê²€ì¦ ë„êµ¬</h1>
    <p class="page-subtitle">ë©”ì‹œì§€ ë°ì´í„°ê°€ ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤</p>
</div>

<div class="grid-2">
    <div class="card">
        <h3 class="card-title mb-4">ğŸ§ª ë°ì´í„° ê²€ì¦</h3>

        <div class="form-group">
            <label class="form-label">ìŠ¤í‚¤ë§ˆ ì„ íƒ</label>
            <select id="schemaSelect" class="form-select" onchange="loadSampleData()">
                <option value="">-- ìŠ¤í‚¤ë§ˆë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                {{range .Schemas}}
                <option value="{{.Name}}">{{.Name}} (v{{.Version}})</option>
                {{end}}
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">JSON ë°ì´í„°</label>
            <textarea id="jsonData" class="form-textarea" placeholder='JSON ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”...'></textarea>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="validateData()" class="btn btn-primary">âœ… ê²€ì¦í•˜ê¸°</button>
            <button onclick="loadSampleData()" class="btn btn-outline">ğŸ“ ìƒ˜í”Œ ë°ì´í„°</button>
            <button onclick="clearForm()" class="btn btn-outline">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>

        <div id="validationResult" class="mt-4" style="display: none;"></div>
    </div>

    <div class="card">
        <h3 class="card-title mb-4">ğŸ“‹ ìƒ˜í”Œ ë°ì´í„°</h3>

        <div class="mb-4">
            <strong>OrderEvent</strong>
            <div class="code-block" style="margin-top: 8px; font-size: 0.8rem;">
<pre>{
  "order_id": "ORD-001",
  "customer_id": "CUST-100",
  "amount": 150000,
  "status": "created",
  "created_at": "2024-01-15T10:30:00Z"
}</pre>
            </div>
        </div>

        <div class="mb-4">
            <strong>PaymentEvent</strong>
            <div class="code-block" style="margin-top: 8px; font-size: 0.8rem;">
<pre>{
  "payment_id": "PAY-001",
  "order_id": "ORD-001",
  "amount": 50000,
  "currency": "KRW",
  "status": "completed"
}</pre>
            </div>
        </div>

        <div class="mb-4">
            <strong>UserEvent</strong>
            <div class="code-block" style="margin-top: 8px; font-size: 0.8rem;">
<pre>{
  "user_id": "USR-001",
  "action": "login",
  "timestamp": "2024-01-15T09:00:00Z"
}</pre>
            </div>
        </div>

        <div>
            <strong>âŒ ì‹¤íŒ¨ ì¼€ì´ìŠ¤ (OrderEvent)</strong>
            <div class="code-block" style="margin-top: 8px; font-size: 0.8rem;">
<pre>{
  "order_id": "ORD-002",
  "amount": -5000,
  "status": "invalid_status"
}</pre>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h3 class="card-title mb-4">ğŸ“Š ê²€ì¦ íˆìŠ¤í† ë¦¬</h3>
    <table class="table">
        <thead>
            <tr>
                <th>ì‹œê°„</th>
                <th>ìŠ¤í‚¤ë§ˆ</th>
                <th>ê²°ê³¼</th>
                <th>ë©”ì‹œì§€</th>
            </tr>
        </thead>
        <tbody id="historyTable">
            <tr>
                <td colspan="4" class="text-muted" style="text-align: center; padding: 30px;">
                    ê²€ì¦ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
const sampleData = {
    'OrderEvent': {
        "order_id": "ORD-001",
        "customer_id": "CUST-100",
        "amount": 150000,
        "status": "created",
        "created_at": "2024-01-15T10:30:00Z"
    },
    'PaymentEvent': {
        "payment_id": "PAY-001",
        "order_id": "ORD-001",
        "amount": 50000,
        "currency": "KRW",
        "status": "completed"
    },
    'UserEvent': {
        "user_id": "USR-001",
        "action": "login",
        "timestamp": "2024-01-15T09:00:00Z"
    },
    'NotificationEvent': {
        "type": "email",
        "recipient": "user@example.com",
        "subject": "ì£¼ë¬¸ í™•ì¸",
        "body": "ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤."
    }
};

const history = [];

function loadSampleData() {
    const schemaName = document.getElementById('schemaSelect').value;
    if (schemaName && sampleData[schemaName]) {
        document.getElementById('jsonData').value = JSON.stringify(sampleData[schemaName], null, 2);
    }
}

function clearForm() {
    document.getElementById('schemaSelect').value = '';
    document.getElementById('jsonData').value = '';
    document.getElementById('validationResult').style.display = 'none';
}

async function validateData() {
    const schemaName = document.getElementById('schemaSelect').value;
    const jsonDataStr = document.getElementById('jsonData').value;
    const resultDiv = document.getElementById('validationResult');

    if (!schemaName) {
        alert('ìŠ¤í‚¤ë§ˆë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (!jsonDataStr.trim()) {
        alert('JSON ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    let data;
    try {
        data = JSON.parse(jsonDataStr);
    } catch (err) {
        resultDiv.innerHTML = '<div class="alert alert-danger">âŒ ì˜ëª»ëœ JSON í˜•ì‹: ' + err.message + '</div>';
        resultDiv.style.display = 'block';
        addToHistory(schemaName, false, 'JSON íŒŒì‹± ì˜¤ë¥˜');
        return;
    }

    const response = await fetch('/api/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            schema_name: schemaName,
            data: data
        })
    });

    const result = await response.json();
    const validation = result.data;

    if (validation.valid) {
        resultDiv.innerHTML = '<div class="alert alert-success">âœ… <strong>ê²€ì¦ ì„±ê³µ!</strong> ë°ì´í„°ê°€ ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜í•©ë‹ˆë‹¤.</div>';
        addToHistory(schemaName, true, 'ê²€ì¦ ì„±ê³µ');
    } else {
        let errorsHtml = '<div class="alert alert-danger"><strong>âŒ ê²€ì¦ ì‹¤íŒ¨!</strong><ul style="margin-top: 10px; margin-bottom: 0;">';
        validation.errors.forEach(err => {
            errorsHtml += '<li>' + err + '</li>';
        });
        errorsHtml += '</ul></div>';
        resultDiv.innerHTML = errorsHtml;
        addToHistory(schemaName, false, validation.errors.join(', '));
    }

    resultDiv.style.display = 'block';
}

function addToHistory(schema, success, message) {
    const now = new Date().toLocaleTimeString('ko-KR');
    history.unshift({ time: now, schema, success, message });

    if (history.length > 10) history.pop();

    updateHistoryTable();
}

function updateHistoryTable() {
    const tbody = document.getElementById('historyTable');
    let html = '';

    history.forEach(item => {
        html += `<tr>
            <td class="text-muted">${item.time}</td>
            <td><strong>${item.schema}</strong></td>
            <td>${item.success ? '<span class="text-success">âœ… ì„±ê³µ</span>' : '<span class="text-danger">âŒ ì‹¤íŒ¨</span>'}</td>
            <td class="text-muted">${item.message.substring(0, 50)}${item.message.length > 50 ? '...' : ''}</td>
        </tr>`;
    });

    if (!html) {
        html = '<tr><td colspan="4" class="text-muted" style="text-align: center; padding: 30px;">ê²€ì¦ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    }

    tbody.innerHTML = html;
}
</script>
{{end}}
